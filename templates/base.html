<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>{% block title %}Trucker Profit System{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'tps-blue': {
              'dark': '#1e3a5f',
              'medium': '#2c5282',
            },
            'tps-gray': {
              'light': '#f5f7fa',
              'medium': '#7f8c8d',
              'dark': '#2c3e50',
              'border': '#dce1e6',
              'extralight': '#f8f9fa',
              'table-border': '#ecf0f1'
            },
            'tps-green': {
              'DEFAULT': '#27ae60',
              'text': '#1ea34a',
              'bg': '#d4edda',
              'border': '#155724'
            },
            'tps-red': '#e53935',
            'tps-blue-status': {
              'bg': '#cce5ff',
              'text': '#004085'
            }
          }
        }
      }
    }
  </script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }

    * {
      transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }
    
    button, a {
      transition: all 0.3s ease;
    }

    main {
      animation: slideIn 0.4s ease-out;
    }

    header {
      animation: slideInRight 0.3s ease-out;
      background-color: #1e3a5f;
    }

    .card {
      animation: popIn 0.5s ease-out;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    .stat-card {
      animation: popIn 0.5s ease-out;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1rem;
    }

    .btn-primary {
      background-color: #1e3a5f;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(30, 58, 95, 0.2);
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary:hover {
      background-color: #152845;
      box-shadow: 0 4px 8px rgba(30, 58, 95, 0.3);
    }

    .btn-success {
      background-color: #27ae60;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn-success:hover {
      background-color: #229954;
    }

    .btn-secondary {
      background-color: #7f8c8d;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn-secondary:hover {
      background-color: #566573;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #dce1e6;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      font-size: 0.875rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1e3a5f;
      box-shadow: 0 0 0 2px rgba(30, 58, 95, 0.1);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-backdrop.hidden {
      display: none;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 0.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background-color: #f5f7fa;
    }

    th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #7f8c8d;
      border-bottom: 1px solid #ecf0f1;
    }

    td {
      padding: 0.75rem;
      border-bottom: 1px solid #ecf0f1;
      color: #2c3e50;
    }

    tbody tr:hover {
      background-color: #f5f7fa;
    }

    body {
      background-color: #f5f7fa;
      color: #2c3e50;
    }

    .simple-notify.success {
      background-color: #27ae60 !important;
    }

    .simple-notify.error {
      background-color: #e53935 !important;
    }

    .simple-notify.info {
      background-color: #1e3a5f !important;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f5f7fa;
    }

    ::-webkit-scrollbar-thumb {
      background: #7f8c8d;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2c3e50;
    }

    .text-tps-blue-dark { color: #1e3a5f; }
    .text-tps-gray-dark { color: #2c3e50; }
    .text-tps-gray-medium { color: #7f8c8d; }
    .text-tps-green-text { color: #1ea34a; }
    .text-tps-red { color: #e53935; }
    .bg-tps-blue-dark { background-color: #1e3a5f; }
    .bg-tps-gray-light { background-color: #f5f7fa; }
    .bg-tps-green-bg { background-color: #d4edda; }
    .bg-tps-blue-status-bg { background-color: #cce5ff; }
    .bg-tps-blue-status-text { color: #004085; }
    .border-tps-gray-border { border-color: #dce1e6; }
    .border-tps-green-border { border-color: #155724; }

    @media (max-width: 768px) {
      main { padding: 1rem; }
      header { padding: 1rem; }
      .card { padding: 1rem; }
      h2 { font-size: 1.5rem; }
      h3 { font-size: 1.125rem; }
    }

    @media (max-width: 640px) {
      .card { padding: 0.75rem; }
      button { font-size: 0.875rem; padding: 0.375rem 0.75rem; }
      table { font-size: 0.75rem; }
    }
  </style>
  {% block head %}{% endblock %}
</head>
<body class="bg-tps-gray-light text-tps-gray-dark font-sans">

  <header class="text-white shadow-md">
    <div class="container mx-auto flex justify-between items-center p-4 md:p-6">
      <h1 class="text-lg md:text-xl font-bold">Trucker Profit System</h1>
      {% if session.get('user_name') %}
        <div class="flex items-center gap-2 md:gap-4">
          <div class="bg-tps-blue-medium px-3 py-1.5 rounded-md text-xs md:text-sm font-semibold hidden sm:block" style="background-color: #2c5282; color: white;">
            {{ session.get('user_name') }}
          </div>
          <form method="post" action="{{ url_for('logout') }}" class="m-0">
            <button class="btn-secondary text-xs md:text-sm px-3 py-1.5" type="submit">Logout</button>
          </form>
        </div>
      {% endif %}
    </div>
  </header>

  <main class="container mx-auto p-4 md:p-6 min-h-screen">
    {% block content %}{% endblock %}
  </main>

  <script>
    // ============================================================================
    // BROWSER HISTORY & SESSION MANAGEMENT
    // ============================================================================
    
    /**
     * SESSION PROTECTION STRATEGY:
     * - When user navigates back to login page, clear the session
     * - When user tries to forward to protected pages, require re-authentication
     * - Clear session when page is about to be unloaded from cache
     */

    const currentPage = window.location.pathname;
    const isLoginPage = currentPage === '/' || currentPage === '';

    // Listen for when page is shown (back/forward navigation)
    window.addEventListener('pageshow', function(event) {
      // If page was restored from browser cache (back or forward button)
      if (event.persisted) {
        console.log('üìÑ Page shown from cache:', currentPage);
        
        if (isLoginPage) {
          // User navigated back to login page
          console.log('üîô Back button to login page - clearing session');
          
          // Clear session from server
          fetch('/clear-session', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
              console.log('‚úÖ Session cleared:', data);
            })
            .catch(err => console.error('Session clear error:', err));
        } else {
          // User navigated to protected page (forward button)
          console.log('‚è© Forward button to protected page - checking auth');
          
          fetch('/check-auth')
            .then(response => {
              if (response.status === 401) {
                console.log('‚ùå Not authenticated');
                window.location.href = '/';
              }
            })
            .catch(err => {
              console.log('‚ùå Auth check failed');
              window.location.href = '/';
            });
        }
      }
    });

    // Modal management
    function showModal(id) {
      const modal = document.getElementById(id);
      if(modal) modal.classList.remove('hidden');
    }
    function hideModal(id) {
      const modal = document.getElementById(id);
      if(modal) modal.classList.add('hidden');
    }
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-backdrop')) {
        hideModal(e.target.id);
      }
    });

    // Toasts for Flashed Messages
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          new Notify({
            status: '{{ "info" if category == "message" else category }}',
            title: '{{ message }}',
            effect: 'fade',
            speed: 300,
            showIcon: true,
            showCloseButton: true,
            autoclose: true,
            autotimeout: 3000,
            gap: 20,
            distance: 20,
            type: 1,
            position: 'right top'
          });
        {% endfor %}
      {% endif %}
    {% endwith %}
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>